<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>オニたいじゲーム</title>

<style>
body{
    margin:0;
    background:black;
    overflow:hidden;
    touch-action:manipulation;
    font-family:sans-serif;
    color:white;
    text-align:center;
}
#game{
    position:relative;
    width:100vw;
    height:100vh;
    display:none;
}
.note{
    position:absolute;
    width:100px;
    height:100px;
    background-size:cover;
    border-radius:10%;
}
#judge{
    position:absolute;
    bottom:120px;
    width:100%;
    height:100px;
    border-top:4px solid yellow;
}
.column{
    position:absolute;
    top:0;
    height:100%;
    opacity:0.1;
}
.column0{left:0%; width:16.66%; background:red;}
.column1{left:16.66%; width:16.66%; background:blue;}
.column2{left:33.32%; width:16.66%; background:green;}
.column3{left:49.98%; width:16.66%; background:orange;}
.column4{left:66.64%; width:16.66%; background:purple;}
.column5{left:83.3%; width:16.7%; background:yellow;}
#ui{
    position:absolute;
    top:10px;
    left:10px;
}
#ranking{
    position:absolute;
    right:10px;
    top:10px;
    font-size:14px;
}
#startBtn{
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px 40px;
    font-size: 24px;
    border-radius: 12px;
    cursor: pointer;
    z-index: 1000;
}
</style>
</head>
<body>
<h1>オニたいじゲーム</h1>
<button id="startBtn">スタート</button>

<div id="game">
    <div id="ui">
        スコア: <span id="score">0</span><br>
        残り時間: <span id="time">30</span>
    </div>
    <div id="ranking"></div>
    <div id="judge"></div>

    <div class="column column0"></div>
    <div class="column column1"></div>
    <div class="column column2"></div>
    <div class="column column3"></div>
    <div class="column column4"></div>
    <div class="column column5"></div>
</div>

<script>
// ---------------------
// BGM 簡単ループ音（Web Audio API）
// ---------------------
let audioCtx, oscillator;
function startBGM(){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // ユーザー操作後に確実に再生
    audioCtx.resume().then(()=>{
        oscillator = audioCtx.createOscillator();
        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
        oscillator.connect(audioCtx.destination);
        oscillator.start();
    });
}

// 効果音
const hitSound = new Audio("hit.mp3");
const bombSound = new Audio("bomb.mp3");

// ---------------------
const startBtn = document.getElementById("startBtn");
const game = document.getElementById("game");
const scoreEl = document.getElementById("score");
const timeEl = document.getElementById("time");
const rankingEl = document.getElementById("ranking");

let score = 0;
let notes = [];
let timeLeft = 30;
let playing = false;
const judgeY = window.innerHeight - 150;
const judgeRange = 100;

// ノーツ画像と列
const images = [
    {src:"bomb.png", score:-100, col:0, sound:"bomb"},
    {src:"oni_blue.png", score:100, col:1, sound:"hit"},
    {src:"oni_green.png", score:100, col:2, sound:"hit"},
    {src:"oni_orange.png", score:100, col:3, sound:"hit"},
    {src:"oni_purple.png", score:100, col:4, sound:"hit"},
    {src:"oni_yellow.png", score:-100, col:5, sound:"bomb"}
];

// ---------------------
// ゲーム開始
// ---------------------
startBtn.addEventListener("click", ()=>{
    startBtn.style.display="none";
    game.style.display="block";
    playing = true;
    startBGM();
    startGame();
});

function startGame(){
    // ノーツ生成
    setInterval(()=>{
        if(!playing) return;
        const n = document.createElement("div");
        n.className="note";
        n.y = -100;
        const img = images[Math.floor(Math.random()*images.length)];
        n.imgData = img;

        const colWidth = window.innerWidth/6;
        n.x = img.col * colWidth + (colWidth-100)/2;
        n.style.left = n.x+"px";
        n.style.top = n.y+"px";
        n.style.backgroundImage = `url(${img.src})`;

        game.appendChild(n);
        notes.push(n);
    },600);

    // ノーツ落下
    function update(){
        if(!playing) return;
        notes.forEach((n,i)=>{
            n.y += 4;
            n.style.top = n.y+"px";
            if(n.y > window.innerHeight){
                n.remove();
                notes.splice(i,1);
            }
        });
        requestAnimationFrame(update);
    }
    update();

    // タップ判定
    game.addEventListener("touchstart", e=>{
        if(!playing) return;
        const x = e.touches[0].clientX;

        notes.forEach((n,i)=>{
            const colWidth = window.innerWidth/6;
            const colIndex = Math.floor(x / colWidth);

            if(Math.abs(n.y - judgeY) < judgeRange && n.imgData.col === colIndex){
                score += n.imgData.score;
                scoreEl.textContent = score;

                if(n.imgData.sound === "hit"){
                    hitSound.currentTime=0; hitSound.play();
                } else {
                    bombSound.currentTime=0; bombSound.play();
                }

                if(n.imgData.src==="bomb.png" || n.imgData.src==="oni_yellow.png"){
                    if(navigator.vibrate) navigator.vibrate(200);
                }

                n.remove();
                notes.splice(i,1);
            }
        });
    });

    // タイマー
    const timer = setInterval(()=>{
        if(!playing) return;
        timeLeft--;
        timeEl.textContent = timeLeft;
        if(timeLeft <= 0) endGame();
    },1000);
}

// ---------------------
// ランキング
// ---------------------
function endGame(){
    playing=false;
    if(oscillator) oscillator.stop();

    let ranks = JSON.parse(localStorage.getItem("ranks")||"[]");
    ranks.push(score);
    ranks.sort((a,b)=>b-a);
    ranks = ranks.slice(0,5);

    localStorage.setItem("ranks", JSON.stringify(ranks));
    showRanking(ranks);
    alert("終了！スコア："+score);
}

function showRanking(ranks){
    rankingEl.innerHTML="<b>ランキング</b><br>";
    ranks.forEach((r,i)=>{
        rankingEl.innerHTML += `${i+1}位 : ${r}<br>`;
    });
}
showRanking(JSON.parse(localStorage.getItem("ranks")||"[]"));
</script>
</body>
</html>
