<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>オニたいじゲーム</title>

<style>
body{
    margin:0;
    background:black;
    overflow:hidden;
    touch-action:manipulation;
    font-family:sans-serif;
    color:white;
}
#game{
    position:relative;
    width:100vw;
    height:100vh;
}
.note{
    position:absolute;
    width:60px;
    height:60px;
    background-size:cover;
    border-radius:10%;
}
#judge{
    position:absolute;
    bottom:120px;
    width:100%;
    height:80px;
    border-top:3px solid yellow;
}
#ui{
    position:absolute;
    top:10px;
    left:10px;
}
#ranking{
    position:absolute;
    right:10px;
    top:10px;
    font-size:14px;
}
</style>
</head>

<body>
<div id="game">
    <div id="ui">
        スコア: <span id="score">0</span><br>
        残り時間: <span id="time">30</span>
    </div>
    <div id="ranking"></div>
    <div id="judge"></div>
</div>

<script>
const game = document.getElementById("game");
const scoreEl = document.getElementById("score");
const timeEl = document.getElementById("time");
const rankingEl = document.getElementById("ranking");

let score = 0;
let notes = [];
let timeLeft = 30;
let playing = true;

// 判定線の位置と範囲
const judgeY = window.innerHeight - 150;
const judgeRange = 80;

// ノーツ画像の種類
const images = [
    {src:"bomb.png", score:-100},
    {src:"oni_blue.png", score:100},
    {src:"oni_green.png", score:100},
    {src:"oni_orange.png", score:100},
    {src:"oni_purple.png", score:100},
    {src:"oni_yellow.png", score:100}
];

// ノーツ生成
setInterval(()=>{
    if(!playing) return;

    const n = document.createElement("div");
    n.className="note";

    // 横位置ランダム
    n.x = Math.random()*(window.innerWidth-60);
    n.y = -60;

    // 画像ランダム選択
    const img = images[Math.floor(Math.random()*images.length)];
    n.imgData = img;

    n.style.left = n.x+"px";
    n.style.top = n.y+"px";
    n.style.backgroundImage = `url(${img.src})`;

    game.appendChild(n);
    notes.push(n);
},500);

// ノーツ落下
function update(){
    if(!playing) return;

    notes.forEach((n,i)=>{
        n.y += 4;
        n.style.top = n.y+"px";

        if(n.y > window.innerHeight){
            n.remove();
            notes.splice(i,1);
        }
    });

    requestAnimationFrame(update);
}
update();

// タップ判定
game.addEventListener("touchstart", e=>{
    if(!playing) return;

    const y = e.touches[0].clientY;
    const x = e.touches[0].clientX;

    notes.forEach((n,i)=>{
        // 判定線を基準にタップ
        if(Math.abs(n.y - judgeY) < judgeRange){
            score += n.imgData.score;
            scoreEl.textContent = score;
            n.remove();
            notes.splice(i,1);
        }
    });
});

// タイマー
const timer = setInterval(()=>{
    if(!playing) return;

    timeLeft--;
    timeEl.textContent = timeLeft;

    if(timeLeft <= 0){
        endGame();
    }
},1000);

// ランキング保存（ローカル保存）
function endGame(){
    playing=false;
    clearInterval(timer);

    let ranks = JSON.parse(localStorage.getItem("ranks")||"[]");
    ranks.push(score);
    ranks.sort((a,b)=>b-a);
    ranks = ranks.slice(0,5);

    localStorage.setItem("ranks", JSON.stringify(ranks));
    showRanking(ranks);

    alert("終了！スコア："+score);
}

function showRanking(ranks){
    rankingEl.innerHTML="<b>ランキング</b><br>";
    ranks.forEach((r,i)=>{
        rankingEl.innerHTML += `${i+1}位 : ${r}<br>`;
    });
}

showRanking(JSON.parse(localStorage.getItem("ranks")||"[]"));
</script>
</body>
</html>
